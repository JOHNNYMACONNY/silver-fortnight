# TradeYa Gamification Database Schema

**Status**: Phase 1 IMPLEMENTED ‚úÖ  
**Date**: June 2, 2025  
**Database**: Firebase Firestore

This document provides comprehensive documentation of the gamification system database schema, including collection structures, field definitions, relationships, and indexing requirements.

## Overview

The TradeYa gamification system uses 4 primary Firestore collections to track user progress, achievements, and XP transactions:

- `userXP` - User experience points and level data
- `xpTransactions` - Historical record of all XP awards
- `achievements` - Achievement definitions and metadata
- `userAchievements` - User achievement unlock records

## Collection Schemas

### 1. userXP Collection

**Purpose**: Stores user experience points, current level, and progression data.

**Document ID**: `{userId}` (matches Firebase Auth UID)

```typescript
interface UserXP {
  id?: string;                    // Document ID (optional in writes)
  userId: string;                 // Firebase Auth UID
  totalXP: number;                // Total accumulated XP
  currentLevel: number;           // Current user level (1-7)
  xpToNextLevel: number;          // XP needed to reach next level
  lastUpdated: Timestamp;         // Last XP update timestamp
  createdAt: Timestamp;           // Account creation timestamp
}
```

**Example Document**:
```json
{
  "userId": "abc123def456",
  "totalXP": 750,
  "currentLevel": 4,
  "xpToNextLevel": 250,
  "lastUpdated": "2025-06-02T10:30:00Z",
  "createdAt": "2025-05-15T08:00:00Z"
}
```

**Indexes Required**:
- `totalXP` (descending) - For leaderboards
- `currentLevel` (descending) - For level-based queries
- `lastUpdated` (descending) - For recent activity

### 2. xpTransactions Collection

**Purpose**: Historical log of all XP awards for transparency and analytics.

**Document ID**: Auto-generated by Firestore

```typescript
interface XPTransaction {
  id?: string;                    // Document ID (auto-generated)
  userId: string;                 // Firebase Auth UID
  amount: number;                 // XP amount awarded (positive integer)
  source: XPSource;               // Source of XP award (enum)
  sourceId?: string;              // ID of related entity (trade, role, etc.)
  description: string;            // Human-readable description
  multiplier?: number;            // Bonus multiplier applied (optional)
  createdAt: Timestamp;           // Transaction timestamp
}

enum XPSource {
  TRADE_COMPLETION = 'trade_completion',
  ROLE_COMPLETION = 'role_completion',
  COLLABORATION_COMPLETION = 'collaboration_completion',
  PROFILE_COMPLETION = 'profile_completion',
  EVIDENCE_SUBMISSION = 'evidence_submission',
  QUICK_RESPONSE = 'quick_response',
  FIRST_TIME_BONUS = 'first_time_bonus',
  STREAK_BONUS = 'streak_bonus',
  ACHIEVEMENT_UNLOCK = 'achievement_unlock'
}
```

**Example Document**:
```json
{
  "id": "txn_789xyz",
  "userId": "abc123def456",
  "amount": 150,
  "source": "role_completion",
  "sourceId": "role_456def",
  "description": "Role completion (complex role)",
  "createdAt": "2025-06-02T10:30:00Z"
}
```

**Indexes Required**:
- `userId, createdAt` (compound, descending) - For user transaction history
- `source, createdAt` (compound) - For analytics by source type
- `createdAt` (descending) - For global activity feed

### 3. achievements Collection

**Purpose**: Stores achievement definitions, unlock conditions, and metadata.

**Document ID**: `{achievementId}` (predefined achievement identifiers)

```typescript
interface Achievement {
  id: string;                     // Achievement identifier
  title: string;                  // Display title
  description: string;            // Achievement description
  category: AchievementCategory;  // Achievement category (enum)
  rarity: AchievementRarity;      // Rarity level (enum)
  icon: string;                   // Emoji or icon identifier
  xpReward: number;               // XP awarded when unlocked
  unlockConditions: AchievementCondition[]; // Unlock requirements
  isHidden?: boolean;             // Hidden until unlocked (optional)
  createdAt: Timestamp;           // Achievement creation date
}

enum AchievementCategory {
  TRADING = 'trading',
  COLLABORATION = 'collaboration',
  COMMUNITY = 'community',
  SKILL = 'skill',
  MILESTONE = 'milestone',
  SPECIAL = 'special'
}

enum AchievementRarity {
  COMMON = 'common',
  UNCOMMON = 'uncommon',
  RARE = 'rare',
  EPIC = 'epic',
  LEGENDARY = 'legendary'
}

interface AchievementCondition {
  type: ConditionType;            // Condition type (enum)
  target: number;                 // Target value to reach
  current?: number;               // Current progress (optional)
  metadata?: Record<string, any>; // Additional condition data
}

enum ConditionType {
  TRADE_COUNT = 'trade_count',
  ROLE_COUNT = 'role_count',
  XP_TOTAL = 'xp_total',
  STREAK_DAYS = 'streak_days',
  SKILL_LEVEL = 'skill_level',
  EVIDENCE_COUNT = 'evidence_count',
  QUICK_RESPONSES = 'quick_responses',
  COLLABORATION_RATING = 'collaboration_rating'
}
```

**Example Document**:
```json
{
  "id": "first_trade",
  "title": "First Trade",
  "description": "Complete your first trade on TradeYa",
  "category": "trading",
  "rarity": "common",
  "icon": "ü§ù",
  "xpReward": 50,
  "unlockConditions": [
    {
      "type": "trade_count",
      "target": 1
    }
  ],
  "createdAt": "2025-06-02T00:00:00Z"
}
```

**Indexes Required**:
- `category` - For filtering achievements by category
- `rarity` - For filtering by rarity level
- `createdAt` - For chronological ordering

### 4. userAchievements Collection

**Purpose**: Tracks which achievements users have unlocked and when.

**Document ID**: Auto-generated by Firestore

```typescript
interface UserAchievement {
  id?: string;                    // Document ID (auto-generated)
  userId: string;                 // Firebase Auth UID
  achievementId: string;          // Achievement identifier
  unlockedAt: Timestamp;          // Unlock timestamp
  progress?: number;              // Progress for multi-step achievements
  isNotified?: boolean;           // Whether user was notified
}
```

**Example Document**:
```json
{
  "id": "user_ach_123",
  "userId": "abc123def456",
  "achievementId": "first_trade",
  "unlockedAt": "2025-06-02T10:30:00Z",
  "isNotified": true
}
```

**Indexes Required**:
- `userId, unlockedAt` (compound, descending) - For user achievement history
- `achievementId, unlockedAt` (compound) - For achievement unlock analytics
- `userId, achievementId` (compound) - For checking if user has achievement

## Data Relationships

### User Progress Flow
```
User completes action (trade/role) 
    ‚Üì
XP awarded ‚Üí xpTransactions record created
    ‚Üì
userXP record updated (totalXP, currentLevel, xpToNextLevel)
    ‚Üì
Achievement conditions checked
    ‚Üì
If achievement unlocked ‚Üí userAchievements record created
    ‚Üì
Additional XP awarded for achievement ‚Üí xpTransactions record created
```

### Level Calculation Logic
```typescript
// Level tiers defined in application code
const LEVEL_TIERS = [
  { level: 1, title: 'Newcomer', minXP: 0, maxXP: 100 },
  { level: 2, title: 'Explorer', minXP: 101, maxXP: 250 },
  { level: 3, title: 'Contributor', minXP: 251, maxXP: 500 },
  { level: 4, title: 'Specialist', minXP: 501, maxXP: 1000 },
  { level: 5, title: 'Expert', minXP: 1001, maxXP: 2000 },
  { level: 6, title: 'Master', minXP: 2001, maxXP: 5000 },
  { level: 7, title: 'Legend', minXP: 5001, maxXP: Infinity }
];
```

## Security Rules

### Firestore Security Rules
```javascript
// userXP collection
match /userXP/{userId} {
  allow read: if request.auth != null;
  allow write: if false; // Only server-side writes allowed
}

// xpTransactions collection
match /xpTransactions/{transactionId} {
  allow read: if request.auth != null && 
              request.auth.uid == resource.data.userId;
  allow write: if false; // Only server-side writes allowed
}

// achievements collection
match /achievements/{achievementId} {
  allow read: if request.auth != null;
  allow write: if false; // Static data, no client writes
}

// userAchievements collection
match /userAchievements/{userAchievementId} {
  allow read: if request.auth != null && 
              request.auth.uid == resource.data.userId;
  allow write: if false; // Only server-side writes allowed
}
```

## Performance Considerations

### Query Optimization
- **User XP Lookup**: Single document read by userId (O(1))
- **User Transaction History**: Compound index on userId + createdAt
- **Achievement Checking**: Batch reads for multiple achievements
- **Leaderboards**: Index on totalXP for efficient sorting

### Caching Strategy
- **User XP Data**: Cache in React component state for session duration
- **Achievement Definitions**: Cache globally as they rarely change
- **Recent Transactions**: Cache last 10 transactions per user

### Write Optimization
- **Atomic Updates**: Use Firestore transactions for XP awards
- **Batch Operations**: Group related writes (XP + achievement unlocks)
- **Minimal Writes**: Only update changed fields in userXP documents

## Migration and Maintenance

### Data Migration
- **Existing Users**: Initialize userXP records with 0 XP for existing users
- **Achievement Backfill**: Check existing user data for retroactive achievement unlocks
- **Historical Data**: Preserve existing trade/collaboration completion data

### Monitoring and Analytics
- **XP Distribution**: Monitor XP award patterns and balance
- **Achievement Unlock Rates**: Track which achievements are too easy/hard
- **User Progression**: Analyze level progression curves and bottlenecks
- **Performance Metrics**: Monitor query performance and document sizes

## Backup and Recovery

### Data Backup
- **Daily Exports**: Automated Firestore exports to Cloud Storage
- **Critical Collections**: Priority backup for userXP and userAchievements
- **Point-in-Time Recovery**: Maintain 30-day backup retention

### Data Integrity
- **Validation Rules**: Server-side validation for all XP transactions
- **Audit Trails**: Complete transaction history for debugging
- **Consistency Checks**: Periodic validation of XP totals vs. transaction sums
