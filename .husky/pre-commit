#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# TradeYa Documentation Pre-commit Hooks
# Ensures documentation quality and consistency before commits

echo "ğŸ” Running documentation pre-commit checks..."

# Check if documentation files were modified
DOCS_MODIFIED=$(git diff --cached --name-only | grep -E '^docs/.*\.md$' | wc -l)

if [ "$DOCS_MODIFIED" -gt 0 ]; then
  echo "ğŸ“š Documentation files detected, running validation..."
  
  # Install dependencies if needed
  if [ ! -d "node_modules" ]; then
    echo "ğŸ“¦ Installing dependencies..."
    npm ci
  fi
  
  # Install tsx if not available
  if ! command -v tsx &> /dev/null; then
    echo "ğŸ”§ Installing tsx..."
    npm install -g tsx
  fi
  
  # Run documentation validation
  echo "ğŸ”— Validating cross-references..."
  if ! npx tsx scripts/maintain-docs.ts validate; then
    echo "âŒ Documentation validation failed!"
    echo "ğŸ’¡ Fix broken references before committing"
    exit 1
  fi
  
  # Check Firestore documentation priority
  echo "ğŸ”¥ Checking Firestore documentation priority..."
  if ! npx tsx scripts/maintain-docs.ts priority; then
    echo "âŒ Firestore documentation check failed!"
    echo "ğŸ’¡ Ensure Firestore docs are properly maintained"
    exit 1
  fi
  
  # Run quick health check
  echo "ğŸ“Š Running documentation health check..."
  if ! npx tsx scripts/maintain-docs.ts health; then
    echo "âš ï¸ Documentation health check completed with warnings"
    echo "ğŸ’¡ Consider running 'npm run docs:dashboard' to address issues"
  fi
  
  echo "âœ… Documentation pre-commit checks passed!"
else
  echo "ğŸ“ No documentation changes detected, skipping docs validation"
fi

# Standard pre-commit checks
echo "ğŸ§¹ Running standard pre-commit checks..."

# Lint staged files
if command -v npx lint-staged &> /dev/null; then
  npx lint-staged
fi

# Run TypeScript check on staged files
TYPESCRIPT_FILES=$(git diff --cached --name-only | grep -E '\.(ts|tsx)$' | wc -l)

if [ "$TYPESCRIPT_FILES" -gt 0 ]; then
  echo "ğŸ” TypeScript files detected, running type check..."
  if ! npm run type-check; then
    echo "âŒ TypeScript check failed!"
    echo "ğŸ’¡ Fix type errors before committing"
    exit 1
  fi
fi

echo "âœ… All pre-commit checks passed!"
npm run pre-commit
npm run pre-commit
npm run pre-commit
npm run pre-commit
npm run pre-commit
npm run pre-commit
npm run pre-commit
npm run pre-commit
npm run pre-commit
npm run pre-commit
npm run pre-commit
